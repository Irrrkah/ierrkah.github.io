<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.16/esri/themes/light/main.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Darker Grotesque">
    <!-- <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&display=swap" > -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@700&family=PT+Sans&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@700&display=swap" rel="stylesheet">
    <script src="https://js.arcgis.com/4.16/"></script>
    <style>
        html,
        body,
        #viewDiv {
          padding: 0;
          margin: 0;
          height: 100%;
        }

        /* #containerDiv {
            padding: 0px;
            text-align: left;
            height: 245px;
        } */

        #infoDiv {
            background-color: indianred;
        }

        #histogram {
            padding: 0px;
            /* height: 210px; */
            /* background-color: gold; */
        }

        #histogram-title {
            width: 280px;
            padding: 7px;
            margin: 0px;
            text-align: center;
            /* background-color: fuchsia; */
        }

        /* DROPUP */
        /* Dropup Button */
        .dropbtn {
            background-color:rgb(141,170,58);
            color: white;
            padding: 10px;
            font-size: 16px;
            border: none;
        }

        /* The container <div> - needed to position the dropup content */
        .dropup {
            position: relative;
            display: inline-block;
        }

        /* Dropup content (Hidden by Default) */
        .dropup-content {
            display: none;
            position: absolute;
            bottom: 50px;
            background-color: #f1f1f1;
            /* min-width: 300px; */
            /* height: 245px; */
            /* box-shadow: 1px 1px 1px 1px rgba(0,0,0,0.2); */
            z-index: 1;
        }

        /* Links inside the dropup - only info button */
        .dropup-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        
        /* Change color of dropup links on hover */
        .dropup-content a:hover {background-color: #ddd}
        /* Change the background color of the dropup button when the dropup content is shown */
        .dropup:hover .dropbtn {
            background-color:rgb(64,25,163);
        }
        .show {display:block;}

        .esri-view-height-small .esri-expand .esri-widget--panel, .esri-view-height-small .esri-expand .esri-widget--panel-height-only, .esri-view-height-small .esri-ui-corner .esri-component.esri-widget--panel, .esri-view-height-small .esri-ui-corner .esri-component.esri-widget--panel-height-only {
            max-height: 420px;
            width: 240px;
        }

      </style>
</head>
<body style = 'background-color:rgb(2,2,2);'>
    <header class='Text' style = 'background-color:rgb(141,170,58); padding: 1px;'>
        <h1 style = 'margin: 10px;
                    font-family: Noto Sans;
                    font-weight: bold;
                    font-size: 7; 
                    color: white;
                    background-color:rgb(141,170,58);'> 
                    <!-- <br> -->
                        Restaurants in LA County and their scores from health inspection 2018-2020
                    <br>
                    <!-- <br> -->
        </h1>
        <p style = 'margin: 10px; 
                    font-family: PT Sans, sans-serif; 
                    font-style: normal;
                    color: white;
                    font-size: 18px;'>
            Zoom in until separate dots of restaurants appear. Some restaurants have same locations, so they might hide under others. Use popups to find particular facilities if they do not appear on their places. The database does not include Pasadena, Long Beach, and Vernon.
        </p>
    </header>
    <div id="viewDiv">
        
    </div>
    <!-- <div id="containerDiv" style = 'background-color:rgb(255, 255, 255)' class = "esri-widget">
        <div id="histogramDiv">
            <p style = 'margin: 10px; 
                font-family: Noto Sans, sans-serif;
                font-weight: normal;
                font-size: 16px;
                text-align: center;'>
                Distribution of Scores
            </p>
        </div>
    </div> -->


    <div id="infoDiv" class="dropup">
        <button onclick="myFunctionINFO()" id="infobtn" class="dropbtn" style='font-family: PT Sans, sans-serif;'>Info</button>
        <div id="myInfo" class="dropup-content" style='
        background-color: #f1f1f1;
        height: 145px;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);'>
            <a target="_blank" rel="noopener noreferrer" href="http://publichealth.lacounty.gov/eh/misc/ehpost.htm" style='font-family: PT Sans, sans-serif;'>Restaurant/Market Grading System</a>
            <a target="_blank" rel="noopener noreferrer" href="https://data.lacounty.gov/Health/COUNTY-OF-LOS-ANGELES-RESTAURANT-AND-MARKET-INSPEC/6ni6-h5kp" style='font-family: PT Sans, sans-serif;'>Data</a>
            <a target="_blank" rel="noopener noreferrer" href="https://ira-koroleva.medium.com/potentially-good-places-to-look-for-dinner-in-la-77bdb18cd7d6" style='font-family: PT Sans, sans-serif;'>Pretty Static Maps</a>
        </div>
    </div> 

    <div id="dropupDiv" class="dropup">
        <button onclick="myFunctionUP()" class="dropbtn" style='font-family: PT Sans, sans-serif;'>Histogram</button>
        <div id="myDropup" class="dropup-content">
            <!-- <div id="containerDiv"> -->
                <p id="histogram-title" class="esri-widget" style='font-family: PT Sans, sans-serif;' >Distribution of Mean Scores</p>
                <div id="histogram"></div>
            <!-- </div> -->
        </div>
      </div>

    <script>
        require([
            // "esri/Basemap",
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/PopupTemplate",
            "esri/widgets/Legend",
            "esri/renderers/SimpleRenderer",
            "esri/symbols/SimpleFillSymbol",
            "esri/widgets/Search",
            "esri/smartMapping/statistics/histogram",
            "esri/widgets/Histogram",
            "esri/smartMapping/statistics/summaryStatistics",
            "esri/widgets/smartMapping/ColorSlider"],
            function(Map, MapView, FeatureLayer, PopupTemplate, Legend, SimpleRenderer, SimpleFillSymbol, Search, histogram, Histogram, summaryStatistics, ColorSlider){
                // let myBasemap = new Basemap({
                //     baseLayers: [
                //         new WebTileLayer(...)
                //     ],
                //     referenceLayers: [
                //         new WebTileLayer(...)
                //     ],
                // });
                
                let myMap = new Map({
                    basemap: 'gray-vector'
                    }
                );
                
                let myMapView = new MapView({
                    map: myMap,
                    container: 'viewDiv',
                    center: [-118.2, 34.0],
                    zoom: 10
                    }
                );

                const Rest1SimpleRenderer = {
                    type: 'simple',
                    symbol: {
                        type: 'simple-marker',
                        size: 4,
                        color: [64,25,163],
                        outline: {
                            color: [43,0,153, 0.5], 
                            width: 5
                        }
                    },
                    visualVariables: [{
                        legendOptions: {
                            title: "Mean Scores From Health Inspections 2018-2020"
                        },
                    }]
                };

                const Rest2SimpleRenderer = {
                    type: 'simple',
                    symbol: {
                        type: 'simple-marker',
                        size: 8,
                        color: '#faebd7',
                        outline: {
                            color: [135,115,199, 0.5],
                            width: 5
                        }
                    }
                };

                const RestContrenderer = {
                    type: 'simple',
                    symbol: {
                        type: 'simple-marker',
                        size: 8,
                        outline: {
                            width: 1.5,
                            color: [0,0,0, 0.6]
                        },
                    },
                    legendOptions: {
                        title: "Mean Points"
                    },
                    visualVariables: [{
                        type: 'color',
                        field: 'score',
                        stops: [
                            {value: 80,
                            color: '#A18000',
                            label: '80'},
                            {value: 90,
                            color: '#FAB733',
                            label: '90'},
                            {value: 95,
                            color: '#74d600',
                            label: '95'},
                            {value: 98,
                            color: '#015200',
                            label: '98'}
                        ]
                    }]
                };

                let Rest1 = new FeatureLayer({
                    url: 'https://services9.arcgis.com/tuaF829zGxPzrij9/arcgis/rest/services/rest_new18_20_unique/FeatureServer',
                    renderer: Rest1SimpleRenderer,
                    maxScale: 8000,
                    popupTemplate: {
                        title: '{facility_n}',
                        content: [{
                            type: 'fields',
                            fieldInfos: [
                                {
                                    fieldName: 'facility_a',
                                    label: 'Facility Address'
                                },
                                {
                                    fieldName: 'score', // HOW TO ROUND - format{}
                                    label: 'Mean Score From Health Inspections 2018-2020'
                                }
                            ]
                        }]
                    }
                });

                Rest1.featureReduction = {
                    type: "cluster",
                    clusterRadius: 50,
                    clusterMinSize: "18px",
                    clusterMaxSize: "70px",
                    popupTemplate: {
                        title: "This cluster represents {cluster_count} restaurants"
                    },
                    labelingInfo: [{
                        deconflictionStrategy: "none",
                        labelExpressionInfo: {expression: "Text($feature.cluster_count, '#,###')"},
                        labelPlacement: "center-center",
                        symbol: {
                            type: 'text',
                            color: '#eceff0', 
                            font: {
                                weight: "bold",
                                family: "Noto Sans",
                                size: "12px"
                            }
                        }
                    }],
                };

                // var Rest1legend = new Legend({
                //     view: myMapView,
                //     layerInfos: [{
                //         layer: Rest1,
                //         title: "Restaurants"
                //     }]
                // });

                // myMapView.ui.add(Rest2legend, "bottom-right");
                // myMapView.ui.add(Rest1legend, "bottom-right");
                myMap.add(Rest1);


                let Rest2 = new FeatureLayer({url: 'https://services9.arcgis.com/tuaF829zGxPzrij9/arcgis/rest/services/rest_new18_20_unique/FeatureServer',
                    renderer: RestContrenderer, // Rest2SimpleRenderer,
                    minScale: 8000,
                    popupTemplate: {
                        title: '{facility_n}',
                        content: [{
                            type: 'fields',
                            fieldInfos: [
                                {
                                    fieldName: 'facility_a',
                                    label: 'Facility Address'
                                },
                                {
                                    fieldName: 'score', // HOW TO ROUND
                                    label: 'Mean Scores From Health Inspections',
                                    format: {
                                        // digitSeparator: true, // Uses a comma separator in numbers >999
                                        places: 1 // Sets the number of decimal places to 0 and rounds up
                                    }
                                },
                                {
                                    fieldName: 'pe_descrip',
                                    label: 'Description: food facility kind, number of seats, risk category'
                                }
                            ]
                        }]
                    },
                    labelingInfo: {
                        symbol: {
                            type: 'text',
                            color: "#063232",
                            font: {
                                weight: "bold",
                                family: "Noto Sans",
                                size: 8,
                            }
                        },
                        labelExpressionInfo: {
                            expression: "$feature.facility_n"
                        }
                    }
                });
                var Rest2legend = new Legend({
                    view: myMapView,
                    layerInfos: [{
                        layer: Rest2,
                        title: "Restaurants"
                    },
                    {
                        fieldName: 'score',
                        label: 'Mean Scores From Health Inspections',
                    }]
                });
                myMap.add(Rest2);
                myMapView.whenLayerView(Rest2).then(function(layerView){
                    myMapView.ui.add(Rest2legend, "top-right");
                });

                const searchWidget = new Search({
                    view: myMapView
                });
                myMapView.ui.add(searchWidget, {
                    position: "top-right",
                });

                // HIST
                myMapView.ui.add("infoDiv", "bottom-left");
                myMapView.ui.add("dropupDiv", "bottom-left");

                let histogramChart;
                let histogramMinLabel = 75;
                let histogramMaxLabel = 100;

                const min = 75; // custom limits
                const max = 100;
                histogram({
                    layer: Rest1,
                    field: "score",
                    numBins: 50,
                    minValue: min,
                    maxValue: max
                }).then(function(histogramResult){
                    const histogramChart = Histogram.fromHistogramResult(histogramResult);
                    histogramChart.container = "histogram";
                    histogramChart.dataLines = [{
                        value: 80,
                        label: "80"
                    },
                    {
                        value: 93.86048, // histogramResult.minValue + 10,  случайная палочка пример
                        label: "93.86 avg"
                    },
                    {
                        value: 67, 
                        label: "min"
                    },
                    {
                        value: 100, 
                        label: "100 max"
                    }];
                    histogramMaxLabel.innerText = histogramResult.maxValue;
                    histogramMinLabel = histogramResult.minValue;
                });
                

            })

        // DROPUP
        function myFunctionUP() {
            document.getElementById("myDropup").classList.toggle("show");
        }

        function myFunctionINFO() {
            document.getElementById("myInfo").classList.toggle("show");
        }

        // Close the dropdown menu if the user clicks outside of it
        window.addEventListener("click", function(event) {
            if (!event.target.matches('.dropbtn')) {
            var dropups = document.getElementsByClassName("dropup-content");
            var i;
            for (i = 0; i < dropups.length; i++) {
                var openDropup = dropups[i];
                if (openDropup.classList.contains('show')) {
                openDropup.classList.remove('show');
                }
            }
            }
        
        })
        
        window.addEventListener("click", function(event) {
            if (!event.target.matches('.dropbtn')) {
                if (document.getElementById("myInfo").classList.contains('show')) {
                    document.getElementById("myInfo").classList.remove('show');
            }
        }});

    </script>
</body>
</html>
